- name: Fix permissions
  file:
    path: /opt/
    owner: 1000
    group: 1000
  become: true


- name: clone repo
  git:
    repo: git@gitlab.com:Gasoid/brusvyanka.git
    dest: /opt/brusvyanka/
    accept_hostkey: yes


- name: Change permissions
  file:
    path: /opt/brusvyanka/
    owner: 1000
    group: 1000
  become: true


- name: install python packages
  pip:
    requirements: /opt/brusvyanka/requirements.txt
    virtualenv: /opt/brusvyanka/.env


- name: Create logs
  file:
    path: /opt/brusvyanka/logs
    state: directory
    owner: www-data
  become: true


- name: Touch errors file
  file:
    path: /opt/brusvyanka/logs/errors.log
    state: touch
    owner: www-data
    mode: 0777
  become: true


- name: migrate db
  django_manage:
    command: migrate
    virtualenv: /opt/brusvyanka/.env/
    app_path: /opt/brusvyanka/
    settings: ilya.server_settings


- file:
    path: /opt/brusvyanka/db.sqlite3
    owner: www-data
  become: true


- name: Fixed permissions
  command: chown -R www-data /opt/brusvyanka/media/
  become: true

- service:
    name: nginx
    state: reloaded
  become: true


- service:
    name: uwsgi
    state: restarted
  become: true